<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Misaka Cipher - Nexus Portal</title>

    <!-- Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Inter:wght@400;600&family=Fira+Code&display=swap"
        rel="stylesheet">

    <!-- Syntax Highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">

    <!-- Custom Styles -->
    <link rel="stylesheet" href="/static/style.css?v=2">
</head>

<body>
    <!-- Header -->
    <header class="header">
        <div class="header-top">
            <h1 class="logo">MISAKA CIPHER</h1>
            <div class="header-right">
                <div class="compact-status" id="compact-status">
                    <span title="Nexus Core">Nexus: <strong id="nexus-status">--</strong></span>
                    <span class="status-divider">|</span>
                    <span title="Active Agents">Agents: <strong id="agents-count">0</strong></span>
                    <span class="status-divider">|</span>
                    <span title="Registered Tools">Tools: <strong id="tools-count">--</strong></span>
                    <span class="status-divider">|</span>
                    <span title="Output Files">Files: <strong id="files-count">--</strong></span>
                </div>
                <div class="status-indicator" id="status-indicator">
                    <span class="status-dot"></span>
                    <span class="status-text">Connecting...</span>
                </div>
            </div>
        </div>
        <nav class="header-nav">
            <div class="main-tabs">
                <button class="main-tab active" data-maintab="chat"><span class="tab-icon">üí¨</span>Chat</button>
                <button class="main-tab" data-maintab="files"><span class="tab-icon">üìÅ</span>Files</button>
                <button class="main-tab" data-maintab="tools"><span class="tab-icon">üîß</span>Tools</button>
                <button class="main-tab" data-maintab="packages"><span class="tab-icon">üì¶</span>Packages</button>
                <button class="main-tab" data-maintab="memory"><span class="tab-icon">üß†</span>Memory</button>
                <button class="main-tab" data-maintab="usage"><span class="tab-icon">üìä</span>Usage</button>
                <button class="main-tab" data-maintab="settings"><span class="tab-icon">‚öôÔ∏è</span>Settings</button>
            </div>
        </nav>
    </header>

    <!-- Main Content Area -->
    <main class="main-container">
        <!-- Chat Tab (4-column layout with threads) -->
        <div class="main-tab-panel active" id="chat-panel">
            <div class="four-column-layout">
                <!-- Far Left: Thread List -->
                <div class="column threads-column">
                    <div class="column-header">
                        <button id="new-thread-button" class="new-thread-button" title="New Thread">+</button>
                    </div>
                    <div class="threads-list" id="threads-list">
                        <!-- Threads will be populated here -->
                    </div>
                </div>
                <!-- Column closed here naturally if we remove the inner div -->
                <!-- The structure is:
                     <div class="four-column-layout">
                       <div class="column threads-column">...</div>
                       <template>...</template>
                       <div class="column logs-column">...</div>
                       ...
                     </div>
                -->
                <!-- So we delete line 66 only -->
                <template id="thread-item-template">
                    <div class="thread-item">
                        <div class="thread-header-row">
                            <div class="thread-info">
                                <div class="thread-title"></div>
                                <div class="thread-meta">
                                    <span class="thread-date"></span>
                                    <span class="thread-mode-badge"
                                        style="display:none; font-size:0.7em; padding:2px 6px; border-radius:4px; background:var(--primary); color:var(--bg-primary);">CHAT
                                        ONLY</span>
                                </div>
                            </div>
                        </div>

                        <!-- Settings Toggle -->
                        <div class="thread-settings-toggle" style="display:none; margin-top:4px;">
                            <span class="toggle-icon">‚ñ∂</span> <span
                                style="font-size:0.85em; opacity:0.8;">SETTINGS</span>
                        </div>

                        <!-- Vertical Stack Settings Panel -->
                        <div class="thread-settings-panel terminal-stack">
                            <!-- Context Mode -->
                            <div class="term-stack-item">
                                <label title="Context Mode: How much history to include">CTX:</label>
                                <select class="term-select" name="contextMode">
                                    <option value="none">None</option>
                                    <option value="smart">Smart</option>
                                    <option value="full">Full</option>
                                </select>
                            </div>

                            <!-- Window -->
                            <div class="term-stack-item">
                                <label title="Context Window: Number of message pairs to remember">WIN:</label>
                                <div style="display:flex; align-items:center; gap:4px;">
                                    <input type="number" class="term-input context-window-input" min="1" max="50"
                                        value="5" style="width:40px; text-align:center;">
                                </div>
                            </div>

                            <!-- Chat Only -->
                            <div class="term-stack-item">
                                <label title="Chat Only Mode: Disable tools/automations">CHAT:</label>
                                <label class="term-check">
                                    <input type="checkbox" class="chat-only-toggle"> Only
                                </label>
                            </div>

                            <!-- Delete -->
                            <div class="term-stack-item" style="margin-top:4px;">
                                <button class="term-btn delete-btn" title="Delete Thread">DELETE THREAD</button>
                            </div>
                        </div>
                    </div>
                </template>

                <!-- Left: System Logs -->
                <div class="column logs-column">
                    <div class="column-header">
                        <h2>System Logs</h2>
                    </div>
                    <div class="logs-container" id="logs-container">
                        <!-- Logs will stream here -->
                    </div>
                </div>

                <!-- Center: Chat Interface -->
                <div class="column chat-column">
                    <div class="column-header">
                        <h2 id="active-thread-title">Main Thread</h2>
                        <div class="header-actions">

                        </div>
                        <div class="voice-button" id="voice-button" title="Voice Input">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z" />
                                <path
                                    d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z" />
                            </svg>
                        </div>
                    </div>

                    <div class="chat-messages" id="chat-messages">
                        <div class="message system-message">
                            <div class="message-content">
                                <strong>System:</strong> Misaka Cipher Nexus Portal initialized.
                                Ask me anything - I'll autonomously coordinate agents, forge tools, and query your
                                knowledge base.
                            </div>
                        </div>
                    </div>

                    <div id="system-terminal" class="system-terminal">
                        <div class="terminal-header">SYSTEM TERMINAL</div>
                        <div class="terminal-content" id="terminal-content">
                            <div class="terminal-line"><span class="term-time">[SYSTEM]</span> Ready.</div>
                        </div>
                    </div>

                    <div class="chat-input-container">
                        <input type="text" id="chat-input" class="chat-input"
                            placeholder="Ask me anything... (e.g., 'Analyze TSLA stock outlook')" autocomplete="off" />
                        <button id="send-button" class="send-button">Send</button>
                    </div>
                </div>

                <!-- Right: Active Agents -->
                <div class="column agents-column">
                    <div class="column-header">
                        <h2>Active Agents</h2>
                    </div>
                    <div class="agents-list" id="agents-list">
                        <div class="no-agents">No active agents</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Files Tab -->
        <div class="main-tab-panel" id="files-panel">
            <div class="panel-header">
                <h2>Workspace Files</h2>
                <div class="file-filters">
                    <select id="domain-filter" class="filter-select">
                        <option value="">All Domains</option>
                        <option value="Finance">Finance</option>
                        <option value="System">System</option>
                        <option value="Data">Data</option>
                        <option value="Code">Code</option>
                        <option value="Audio">Audio</option>
                        <option value="General">General</option>
                    </select>
                    <select id="type-filter" class="filter-select">
                        <option value="">All Types</option>
                        <option value="pdf">PDF</option>
                        <option value="txt">Text</option>
                        <option value="csv">CSV</option>
                        <option value="json">JSON</option>
                        <option value="html">HTML</option>
                    </select>
                    <button id="refresh-files" class="refresh-button">üîÑ Refresh</button>
                </div>
            </div>
            <div class="files-grid" id="files-grid">
                <p class="placeholder-text">No files yet. Ask Misaka to create reports, analysis, or other outputs!</p>
            </div>
        </div>

        <!-- Tools Tab -->
        <div class="main-tab-panel" id="tools-panel">
            <div class="panel-header">
                <h2>Tool Registry</h2>
                <div class="panel-controls">
                    <input type="text" id="tool-search" placeholder="Search tools..." class="search-input">
                    <select id="tool-domain-filter" class="filter-select">
                        <option value="">All Domains</option>
                        <!-- Domains will be populated by JS -->
                    </select>
                    <div class="toggle-control" style="display: flex; align-items: center; margin-right: 1rem;">
                        <input type="checkbox" id="hide-system-tools" style="margin-right: 0.5rem;">
                        <label for="hide-system-tools" style="font-size: 0.9rem; cursor: pointer;">Hide System
                            Tools</label>
                    </div>
                    <button id="refresh-tools-btn" class="action-btn secondary" title="Refresh list">
                        <i class="fas fa-redo"></i> Refresh
                    </button>
                    <button id="forge-tool-button" class="forge-button">+ Forge New Tool</button>
                </div>
            </div>

            <div class="tools-table-container" style="overflow-x: auto;">
                <table class="data-table" id="tools-table" style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="text-align: left; border-bottom: 2px solid var(--border);">
                            <th class="sortable" data-sort="name" style="padding: 10px; cursor: pointer;">Tool Name ‚Üï
                            </th>
                            <th class="sortable" data-sort="domain" style="padding: 10px; cursor: pointer;">Domain ‚Üï
                            </th>
                            <th class="sortable" data-sort="usage" style="padding: 10px; cursor: pointer;">Usage ‚Üï</th>
                            <th style="padding: 10px;">Description</th>
                            <th class="sortable" data-sort="created" style="padding: 10px; cursor: pointer;">Created ‚Üï
                            </th>
                            <th style="padding: 10px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tools-table-body">
                        <!-- Rows injected by JS -->
                        <tr>
                            <td colspan="5" class="placeholder-text" style="text-align: center; padding: 20px;">Loading
                                tools...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Packages Tab -->
        <div class="main-tab-panel" id="packages-panel">
            <div class="panel-header">
                <h2>Package Management</h2>
                <div class="panel-controls">
                    <input type="text" id="package-search" placeholder="Search packages..." class="search-input">
                    <select id="package-status-filter" class="filter-select">
                        <option value="all">All Status</option>
                        <option value="pending">Pending</option>
                        <option value="installed">Installed</option>
                        <option value="approved">Approved</option>
                        <option value="denied">Denied</option>
                        <option value="failed">Failed</option>
                    </select>
                    <div class="toggle-control"
                        style="display: flex; align-items: center; gap: 0.5rem; color: var(--text-secondary); font-size: 0.9rem;">
                        <input type="checkbox" id="hide-system-packages">
                        <label for="hide-system-packages">Hide System Pkgs</label>
                    </div>
                    <button id="sync-packages-btn" class="action-btn secondary" title="Sync with installed packages">
                        <i class="fas fa-sync"></i> Sync
                    </button>
                    <button id="refresh-packages-btn" class="action-btn secondary" title="Refresh list">
                        <i class="fas fa-redo"></i>
                    </button>
                </div>
            </div>

            <div class="packages-table-container" style="overflow-x: auto;">
                <table class="data-table" id="packages-table" style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="text-align: left; border-bottom: 2px solid var(--border);">
                            <th class="sortable" data-sort="name" style="padding: 10px; cursor: pointer;">Package ‚Üï</th>
                            <th class="sortable" data-sort="status" style="padding: 10px; cursor: pointer;">Status ‚Üï
                            </th>
                            <th class="sortable" data-sort="usage" style="padding: 10px; cursor: pointer;">Usage ‚Üï</th>
                            <th class="sortable" data-sort="safety" style="padding: 10px; cursor: pointer;">Safety ‚Üï
                            </th>
                            <th class="sortable" data-sort="updated" style="padding: 10px; cursor: pointer;">Updated ‚Üï
                            </th>
                            <th style="padding: 10px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="packages-table-body">
                        <!-- Rows injected by JS -->
                        <tr>
                            <td colspan="6" class="placeholder-text" style="text-align: center; padding: 20px;">Loading
                                packages...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Memory Tab -->
        <div class="main-tab-panel" id="memory-panel">
            <div class="panel-header">
                <h2>System Memory</h2>
                <div class="panel-controls">
                    <button id="refresh-memory-btn" class="action-btn secondary" title="Refresh memory">
                        <i class="fas fa-redo"></i> Refresh
                    </button>
                </div>
            </div>

            <!-- Permanent Memory Section -->
            <div class="memory-section" style="margin-bottom: 2rem;">
                <h3 style="margin-left: 1rem; color: var(--accent);">Permanent Memory (Core Insights)</h3>
                <div class="tools-table-container" style="overflow-x: auto;">
                    <table class="data-table" id="permanent-memory-table"
                        style="width: 100%; border-collapse: collapse; margin-top: 0.5rem;">
                        <thead>
                            <tr style="text-align: left; border-bottom: 2px solid var(--border);">
                                <th style="padding: 10px;">Insight ID</th>
                                <th style="padding: 10px;">Summary</th>
                                <th style="padding: 10px;">Created</th>
                            </tr>
                        </thead>
                        <tbody id="permanent-memory-body">
                            <!-- Rows injected by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Thread Memory Section -->
            <div class="memory-section">
                <h3 style="margin-left: 1rem; color: var(--accent);">Thread Memory</h3>
                <div id="thread-memory-container">
                    <!-- Dynamic thread tables injected here -->
                    <p class="placeholder-text">Loading thread memories...</p>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <!-- Usage Tab -->
        <div class="main-tab-panel" id="usage-panel">
            <div class="panel-header">
                <h2>Usage Dashboard</h2>
            </div>
            <div class="usage-dashboard">
                <!-- Stat Cards Row -->
                <div class="usage-stat-row">
                    <div class="usage-stat-card">
                        <div class="stat-value" id="usage-total-calls">0</div>
                        <div class="stat-label">Total API Calls</div>
                    </div>
                    <div class="usage-stat-card">
                        <div class="stat-value" id="usage-total-tokens">0</div>
                        <div class="stat-label">Total Tokens</div>
                    </div>
                    <div class="usage-stat-card">
                        <div class="stat-value" id="usage-total-cost">$0.00</div>
                        <div class="stat-label">Estimated Cost</div>
                    </div>
                    <div class="usage-stat-card">
                        <div class="stat-value" id="usage-success-rate">0%</div>
                        <div class="stat-label">Success Rate</div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="usage-charts-row">
                    <div class="usage-chart-container">
                        <h3>API Calls by Provider</h3>
                        <canvas id="chart-provider-calls"></canvas>
                    </div>
                    <div class="usage-chart-container">
                        <h3>Token Usage Over Time</h3>
                        <canvas id="chart-tokens-timeline"></canvas>
                    </div>
                </div>

                <!-- Tables Row -->
                <div class="usage-tables-row">
                    <div class="usage-table-container">
                        <h3>Recent API Calls</h3>
                        <table class="usage-table">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Provider</th>
                                    <th>Model</th>
                                    <th>Tokens</th>
                                    <th>Cost</th>
                                </tr>
                            </thead>
                            <tbody id="usage-recent-tbody">
                                <tr>
                                    <td colspan="5" class="placeholder-text">No data yet</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="usage-table-container">
                        <h3>Tool Usage</h3>
                        <table class="usage-table">
                            <thead>
                                <tr>
                                    <th>Tool</th>
                                    <th>Domain</th>
                                    <th>Uses</th>
                                </tr>
                            </thead>
                            <tbody id="usage-tools-tbody">
                                <tr>
                                    <td colspan="3" class="placeholder-text">No data yet</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div class="main-tab-panel" id="settings-panel">
            <div class="panel-header">
                <h2>System Settings</h2>
            </div>
            <div class="settings-container">
                <div class="setting-group">
                    <h3>Validation & Context</h3>

                    <div class="setting-item">
                        <label class="switch">
                            <input type="checkbox" id="setting-strict-mode">
                            <span class="slider round"></span>
                        </label>
                        <div class="setting-label">
                            <strong>Strict Domain Validation</strong>
                            <span>
                                Enforce Aethvion naming conventions (Domain_Action_Object) and restrict usage to
                                approved
                                domains only.
                                Disable this to allow creating agents with custom domains (e.g. Story_Write_Plot).
                            </span>
                        </div>
                    </div>

                    <div class="setting-item">
                        <label class="switch">
                            <input type="checkbox" id="setting-hide-agents-panel">
                            <span class="slider round"></span>
                        </label>
                        <div class="setting-label">
                            <strong>Hide Active Agents Panel</strong>
                            <span>Toggle visibility of the right-side agents column in Chat view.</span>
                        </div>
                    </div>
                </div>

                <div class="setting-group">
                    <h3>Package Management</h3>
                    <div class="setting-item">
                        <label class="switch">
                            <input type="checkbox" id="setting-hide-system-pkgs">
                            <span class="slider round"></span>
                        </label>
                        <div class="setting-label">
                            <strong>Hide System Packages</strong>
                            <span>Filter out internal system packages from the packages list view.</span>
                        </div>
                    </div>
                </div>

                <div class="setting-group">
                    <h3>Logging</h3>
                    <div class="setting-item">
                        <label class="switch">
                            <input type="checkbox" id="setting-hide-system-logs">
                            <span class="slider round"></span>
                        </label>
                        <div class="setting-label">
                            <strong>Hide System Logs</strong>
                            <span>Filter out verbose system logs (e.g. Uvicorn, WebSocket) from the System Logs
                                panel.</span>
                        </div>
                    </div>
                </div>

                <div class="setting-group">
                    <h3>Provider Settings</h3>
                    <p style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 1rem;">
                        Configure AI providers, priorities, and retry budgets per step. Saved to
                        <code>model_registry.json</code>.
                    </p>
                    <div id="provider-cards-container" class="provider-cards-grid">
                        <div class="loading-placeholder">Loading providers...</div>
                    </div>
                    <div style="margin-top: 1rem; display: flex; align-items: center; gap: 1rem;">
                        <button id="save-provider-settings" class="btn-primary">Save Provider Settings</button>
                        <span id="provider-save-status" style="color: var(--accent); font-size: 0.85rem;"></span>
                    </div>
                </div>
            </div>
        </div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <script src="/static/lib/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="/static/threads.js?v=4"></script>
    <script src="/static/app.js?v=5"></script>
</body>

</html>