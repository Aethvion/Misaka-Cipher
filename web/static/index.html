<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Misaka Cipher - Nexus Portal</title>
    <link rel="icon" href="data:,">

    <!-- Favicons -->
    <link rel="icon" type="image/png" sizes="32x32" href="/static/images/favicon-32.png">
    <link rel="icon" type="image/png" sizes="48x48" href="/static/images/favicon-48.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/static/images/favicon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/static/images/favicon-512.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/images/apple-touch-icon.png">
    <link rel="shortcut icon" href="/static/images/favicon.ico">

    <!-- Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Inter:wght@400;600&family=Fira+Code&display=swap"
        rel="stylesheet">

    <!-- Syntax Highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Custom Styles -->
    <link rel="stylesheet" href="/static/css/base.css">
    <link rel="stylesheet" href="/static/css/layout.css">
    <link rel="stylesheet" href="/static/css/chat.css">
    <link rel="stylesheet" href="/static/css/files_tools.css">
    <link rel="stylesheet" href="/static/css/logs_memory.css">
    <link rel="stylesheet" href="/static/css/packages.css">
    <link rel="stylesheet" href="/static/css/settings.css">
    <link rel="stylesheet" href="/static/css/dashboard.css">
    <link rel="stylesheet" href="/static/css/modals.css">
    <link rel="stylesheet" href="/static/css/terminal.css">
    <link rel="stylesheet" href="/static/css/tables_markdown.css">
    <link rel="stylesheet" href="/static/css/arena.css">
    <link rel="stylesheet" href="/static/css/preferences.css">
    <link rel="stylesheet" href="/static/css/status.css">
    <link rel="stylesheet" href="/static/css/image_studio.css">
    <link rel="stylesheet" href="/static/css/adv_aiconv.css">
</head>

<body>
    <!-- Header -->
    <header class="header">
        <div class="header-top">
            <h1 class="logo">MISAKA CIPHER</h1>
            <div class="header-right">
                <div class="compact-status" id="compact-status">
                    <span title="Tokens Today">Tokens: <strong id="tokens-today">0</strong></span>
                    <span class="status-divider">|</span>
                    <span title="Cost Today">Cost: <strong id="cost-today">$0.00</strong></span>
                    <span class="status-divider">|</span>
                    <span title="Active Agents">Agents: <strong id="agents-count">0</strong></span>
                    <span class="status-divider">|</span>
                    <span title="Registered Tools">Tools: <strong id="tools-count">--</strong></span>
                </div>
                <div class="status-indicator" id="status-indicator">
                    <span class="status-dot"></span>
                    <span class="status-text">Connecting...</span>
                </div>
            </div>
        </div>
        <nav class="header-nav">
            <div class="main-tabs">
                <div class="main-tab-dropdown">
                    <!-- Split Button Group -->
                    <div class="split-btn-group">
                        <button class="main-tab split-main-action active" data-maintab="chat">
                            <span class="tab-icon">üí¨</span>Chat
                        </button>
                        <button class="main-tab split-arrow-action">
                            <span class="dropdown-arrow">‚ñæ</span>
                        </button>
                    </div>

                    <div class="tab-dropdown-menu">
                        <div class="dropdown-category">[Workflow]</div>
                        <button class="tab-dropdown-item active" data-subtab="chat"><span
                                class="tab-icon">üí¨</span>Chat</button>
                        <button class="tab-dropdown-item" data-subtab="agent"><span
                                class="tab-icon">ü§ñ</span>Agent</button>
                        <button class="tab-dropdown-item" data-subtab="image"><span
                                class="tab-icon">üé®</span>Image</button>
                        <div class="dropdown-category">[Research]</div>
                        <button class="tab-dropdown-item" data-subtab="advaiconv"><span
                                class="tab-icon">üß™</span>Advanced AI Conversation</button>
                        <div class="dropdown-category">[Sandbox]</div>
                        <button class="tab-dropdown-item" data-subtab="arena"><span
                                class="tab-icon">‚öîÔ∏è</span>Arena</button>
                        <button class="tab-dropdown-item" data-subtab="aiconv"><span class="tab-icon">üé≠</span>AI
                            Conversations</button>
                    </div>
                </div>
                <button class="main-tab" data-maintab="files"><span class="tab-icon">üìÅ</span>Files</button>
                <button class="main-tab" data-maintab="tools"><span class="tab-icon">üîß</span>Tools</button>
                <button class="main-tab" data-maintab="packages"><span class="tab-icon">üì¶</span>Packages</button>
                <button class="main-tab" data-maintab="memory"><span class="tab-icon">üß†</span>Memory</button>
                <button class="main-tab" data-maintab="logs"><span class="tab-icon">üìú</span>Logs</button>
                <button class="main-tab" data-maintab="usage"><span class="tab-icon">üìä</span>Usage</button>
                <button class="main-tab" data-maintab="status"><span class="tab-icon">üö¶</span>Status</button>
                <button class="main-tab" data-maintab="settings"><span class="tab-icon">‚öôÔ∏è</span>Settings</button>
            </div>
        </nav>
    </header>

    <!-- Main Content Area -->
    <main class="main-container">
        <!-- Chat Tab (4-column layout with threads) -->
        <div class="main-tab-panel active" id="chat-panel">
            <div class="three-column-layout">
                <!-- Far Left: Thread List -->
                <div class="column threads-column">
                    <div class="column-header">
                        <button id="new-thread-button" class="new-thread-button" title="New Thread">+</button>
                    </div>
                    <div class="threads-list" id="threads-list">
                        <!-- Threads will be populated here -->
                    </div>
                </div>
                <!-- ... existing content ... -->

                <template id="thread-item-template">
                    <div class="thread-item">
                        <div class="thread-header-row">
                            <div class="thread-info">
                                <div class="thread-title"></div>
                                <div class="thread-meta">
                                    <span class="thread-date"></span>
                                    <span class="thread-mode-badge"
                                        style="display:none; font-size:0.7em; padding:2px 6px; border-radius:4px; background:var(--primary); color:var(--bg-primary);">CHAT</span>
                                </div>
                            </div>
                        </div>

                        <!-- Settings Toggle -->
                        <div class="thread-settings-toggle" style="display:none; margin-top:4px;">
                            <span class="toggle-icon">‚ñ∂</span> <span
                                style="font-size:0.85em; opacity:0.8;">SETTINGS</span>
                        </div>

                        <!-- Vertical Stack Settings Panel -->
                        <div class="thread-settings-panel terminal-stack">
                            <!-- Context Mode -->
                            <div class="term-stack-item">
                                <label title="Context Mode: How much history to include">CTX:</label>
                                <select class="term-select" name="contextMode">
                                    <option value="none">None</option>
                                    <option value="smart">Smart</option>
                                    <option value="full">Full</option>
                                </select>
                            </div>

                            <!-- Window -->
                            <div class="term-stack-item">
                                <label title="Context Window: Number of message pairs to remember">WIN:</label>
                                <div style="display:flex; align-items:center; gap:4px;">
                                    <input type="number" class="term-input context-window-input" min="1" max="50"
                                        value="5" style="width:40px; text-align:center;">
                                </div>
                            </div>

                            <!-- Transfer -->
                            <div class="term-stack-item">
                                <button class="term-btn transfer-btn"
                                    title="Transfer thread between Chat and Agent">TRANSFER</button>
                            </div>

                            <!-- Delete -->
                            <div class="term-stack-item" style="margin-top:4px;">
                                <button class="term-btn delete-btn" title="Delete Thread">DELETE THREAD</button>
                            </div>
                        </div>
                    </div>
                </template>
                <!-- Center: Chat Interface -->
                <div class="column chat-column">
                    <div class="column-header">
                        <h2 id="active-thread-title">Main Thread</h2>
                        <div class="header-actions">
                        </div>
                    </div>

                    <div class="chat-messages" id="chat-messages">
                        <div class="message system-message">
                            <div class="message-content">
                                <strong>System:</strong> Misaka Cipher Nexus Portal initialized.
                                Ask me anything - I'll autonomously coordinate agents, forge tools, and query your
                                knowledge base.
                            </div>
                        </div>
                    </div>



                    <div class="chat-interface-wrapper">
                        <textarea id="chat-input" class="chat-input" rows="1"
                            placeholder="Ask me anything... (e.g., 'Analyze TSLA stock outlook')"
                            autocomplete="off"></textarea>

                        <div class="input-controls">
                            <div class="controls-left">
                                <button class="icon-btn add-file-btn" title="Add File">
                                    <i class="fas fa-plus"></i>
                                </button>

                                <select id="model-select" class="control-select" title="Select Model">
                                    <option value="auto">Model: Auto</option>
                                </select>

                                <select id="agent-select" class="control-select" title="Select Agent Profile">
                                    <option value="auto">Agent: Auto</option>
                                    <option value="researcher">Researcher</option>
                                    <option value="coder">Coder</option>
                                    <option value="creative">Creative</option>
                                </select>
                            </div>

                            <div class="controls-right">
                                <button id="voice-mode-toggle" class="icon-btn voice-btn" title="Voice Mode">
                                    <i class="fas fa-microphone"></i>
                                </button>
                                <button id="send-button" class="send-button">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right: Active Agents -->
                <div class="column agents-column">
                    <div class="column-header">
                        <h2>Active Agents</h2>
                    </div>
                    <div class="agents-list" id="agents-list">
                        <div class="no-agents">No active agents</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Arena Tab -->
        <div class="main-tab-panel" id="arena-panel">
            <div class="arena-layout">
                <!-- Arena Controls -->
                <div class="arena-controls">
                    <div class="arena-section">
                        <h3>‚öîÔ∏è Arena Models</h3>
                        <p class="arena-hint">Select models to compete. Send a prompt and all models respond.</p>
                        <div class="arena-model-selector">
                            <select id="arena-model-add" class="control-select">
                                <option value="">+ Add Model...</option>
                            </select>
                            <div class="arena-model-chips" id="arena-model-chips">
                                <!-- model chips inserted by JS -->
                            </div>
                        </div>
                    </div>
                    <div class="arena-section">
                        <h3>üßë‚Äç‚öñÔ∏è Evaluator (Optional)</h3>
                        <select id="arena-evaluator" class="control-select" style="width:100%;">
                            <option value="">No Evaluator</option>
                        </select>
                    </div>
                </div>

                <!-- Arena Chat -->
                <div class="arena-chat-area">
                    <div class="arena-responses" id="arena-responses">
                        <div class="arena-placeholder">
                            <span class="tab-icon" style="font-size:3rem;">‚öîÔ∏è</span>
                            <p>Add models and send a prompt to start a battle!</p>
                        </div>
                    </div>
                    <div class="arena-input-wrapper">
                        <textarea id="arena-input" class="chat-input" rows="1"
                            placeholder="Enter a prompt for all models..."></textarea>
                        <button id="arena-send" class="send-button"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>

                <!-- Leaderboard -->
                <div class="arena-leaderboard-section">
                    <div class="arena-leaderboard-header">
                        <h3>üèÜ Leaderboard</h3>
                        <button id="arena-clear-leaderboard" class="action-btn small danger">Clear</button>
                    </div>
                    <table class="usage-table" id="arena-leaderboard-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Model</th>
                                <th>Wins</th>
                                <th>Battles</th>
                                <th>Win Rate</th>
                            </tr>
                        </thead>
                        <tbody id="arena-leaderboard-body">
                            <tr>
                                <td colspan="5" class="placeholder-text">No battles yet</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Logs Tab -->
        <div class="main-tab-panel" id="logs-panel">
            <div class="logs-layout">
                <div class="logs-pane">
                    <div class="logs-pane-header">
                        <h3>üìú System Logs</h3>
                    </div>
                    <div class="logs-container" id="logs-container">
                        <!-- Logs will stream here via WebSocket -->
                    </div>
                </div>
                <div class="logs-pane terminal-pane">
                    <div class="logs-pane-header">
                        <h3>‚ö° System Terminal</h3>
                    </div>
                    <div class="terminal-content" id="terminal-content">
                        <div class="terminal-line"><span class="term-time">[SYSTEM]</span> Ready.</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Conversations Tab -->
        <div class="main-tab-panel" id="aiconv-panel">
            <div class="arena-layout aiconv-layout">
                <!-- AI Conv Controls -->
                <div class="arena-controls aiconv-controls">
                    <div class="arena-section">
                        <h3>üé≠ Conversation Models</h3>
                        <p class="arena-hint">Select models to converse with each other turn by turn.</p>
                        <div class="arena-model-selector">
                            <select id="aiconv-model-add" class="control-select">
                                <option value="">+ Add Model...</option>
                            </select>
                            <div class="arena-model-chips" id="aiconv-model-chips">
                                <!-- model chips inserted by JS -->
                            </div>
                        </div>
                    </div>

                    <div class="arena-section">
                        <h3>‚öôÔ∏è Configuration</h3>

                        <div style="margin-bottom: 0.8rem;">
                            <label
                                style="display:block; font-size:0.8rem; color:var(--text-secondary); margin-bottom:0.25rem;">Messages
                                per Model</label>
                            <input type="number" id="aiconv-msg-count" class="term-input" style="width:100%;" min="1"
                                max="50" value="5">
                        </div>

                        <div style="margin-bottom: 0.8rem;">
                            <label
                                style="display:block; font-size:0.8rem; color:var(--text-secondary); margin-bottom:0.25rem;">Initial
                                Topic / Prompt</label>
                            <textarea id="aiconv-topic" class="chat-input"
                                style="width:100%; min-height:80px; resize:vertical; font-size:0.85rem;"
                                placeholder="E.g., Debate the ethics of AI consciousness..."></textarea>
                        </div>

                        <div style="display:flex; gap: 0.5rem; flex-direction:column; margin-top: 1rem;">
                            <button id="aiconv-start-btn" class="action-btn primary" style="width:100%;">
                                <i class="fas fa-play"></i> Start Conversation
                            </button>
                            <div style="display:flex; gap: 0.5rem;">
                                <button id="aiconv-pause-btn" class="action-btn secondary" style="flex:1;" disabled>
                                    <i class="fas fa-pause"></i> Pause
                                </button>
                                <button id="aiconv-stop-btn" class="action-btn danger" style="flex:1;" disabled>
                                    <i class="fas fa-stop"></i> Stop
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Conv Chat -->
                <div class="arena-chat-area aiconv-chat-area">
                    <!-- Added header row for detailed token tracking -->
                    <div
                        style="padding: 0.5rem 1rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: var(--bg-tertiary); flex-wrap: wrap; gap: 0.5rem;">
                        <h3 style="margin: 0; font-size: 0.9rem; color: var(--primary);">Live Conversation</h3>
                        <div style="font-size: 0.8rem; display: flex; gap: 1rem; flex-wrap: wrap;">
                            <span title="Input Tokens"><i class="fas fa-sign-in-alt"
                                    style="color:var(--text-secondary);"></i> <span id="aiconv-in-tokens"
                                    style="font-weight:bold;">0</span> in</span>
                            <span title="Output Tokens"><i class="fas fa-sign-out-alt"
                                    style="color:var(--text-secondary);"></i> <span id="aiconv-out-tokens"
                                    style="font-weight:bold;">0</span> out</span>
                            <span title="Total Tokens"><i class="fas fa-coins" style="color:var(--text-secondary);"></i>
                                <span id="aiconv-live-tokens" style="font-weight:bold;">0</span> total</span>
                            <span title="Estimated Cost"><i class="fas fa-dollar-sign"
                                    style="color:var(--text-secondary);"></i> <span id="aiconv-live-cost"
                                    style="font-weight:bold; color:var(--success);">0.000</span></span>
                            <span title="Messages Completed/Total"><i class="fas fa-exchange-alt"
                                    style="color:var(--text-secondary);"></i> <span id="aiconv-progress"
                                    style="font-weight:bold;">0/0</span> msgs</span>
                        </div>
                    </div>

                    <div class="chat-messages" id="aiconv-messages"
                        style="flex:1; overflow-y:auto; padding:1rem; background: var(--bg-primary);">
                        <div class="arena-placeholder" id="aiconv-placeholder">
                            <span class="tab-icon" style="font-size:3rem;">üé≠</span>
                            <p>Select models, configure the topic, and start the conversation!</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Advanced AI Conversations Tab -->
        <div class="main-tab-panel" id="advaiconv-panel">
            <div class="advaiconv-split-layout">

                <!-- LEFT SIDEBAR: Controls & Configuration -->
                <div class="advaiconv-sidebar">

                    <!-- Section 1: Threads -->
                    <div class="advaiconv-section">
                        <div class="advaiconv-section-header">
                            <h3><i class="fas fa-list"></i> Threads</h3>
                            <button id="advaiconv-new-thread-btn" class="action-btn secondary xs-btn"
                                title="New Thread"><i class="fas fa-plus"></i></button>
                        </div>
                        <div class="advaiconv-thread-list" id="advaiconv-thread-list">
                            <!-- Populated by JS -->
                            <div class="placeholder-text" style="padding: 0.5rem; font-size: 0.8rem;">No threads found.
                            </div>
                        </div>
                    </div>

                    <!-- Section 2: Environment & Controls -->
                    <div class="advaiconv-section">
                        <div class="advaiconv-section-header">
                            <h3><i class="fas fa-globe"></i> Environment & Controls</h3>
                        </div>
                        <div class="advaiconv-section-body">
                            <div style="margin-bottom: 0.8rem;">
                                <label
                                    style="display:block; font-size:0.8rem; color:var(--text-secondary); margin-bottom:0.25rem;">Topic
                                    / Scenario</label>
                                <textarea id="advaiconv-topic" class="chat-input"
                                    style="width:100%; min-height:60px; resize:vertical; font-size:0.85rem;"
                                    placeholder="E.g., You are locked in a room together..."></textarea>
                            </div>

                            <div style="display:flex; gap: 0.5rem; margin-bottom: 0.8rem;">
                                <div style="flex: 1;">
                                    <label
                                        style="display:block; font-size:0.8rem; color:var(--text-secondary); margin-bottom:0.25rem;"
                                        title="Delay between generation turns in ms">Speed (ms)</label>
                                    <input type="number" id="advaiconv-speed-input" class="term-input"
                                        style="width:100%;" min="0" step="500" value="2000">
                                </div>
                                <div style="flex: 1;">
                                    <label
                                        style="display:block; font-size:0.8rem; color:var(--text-secondary); margin-bottom:0.25rem;"
                                        title="Max history messages to send to LLM">Max Context</label>
                                    <input type="number" id="advaiconv-context-input" class="term-input"
                                        style="width:100%;" min="1" max="100" value="20">
                                </div>
                            </div>

                            <div style="display:flex; gap: 0.5rem; flex-direction:column;">
                                <button id="advaiconv-start-btn" class="action-btn primary" style="width:100%;">
                                    <i class="fas fa-play"></i> Start Simulation
                                </button>
                                <div style="display:flex; gap: 0.5rem;">
                                    <button id="advaiconv-pause-btn" class="action-btn secondary" style="flex:1;"
                                        disabled>
                                        <i class="fas fa-pause"></i> Pause
                                    </button>
                                    <button id="advaiconv-stop-btn" class="action-btn danger" style="flex:1;" disabled>
                                        <i class="fas fa-stop"></i> Stop
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section 3: People Settings -->
                    <div class="advaiconv-section">
                        <div class="advaiconv-section-header">
                            <h3><i class="fas fa-users"></i> Research Subjects</h3>
                            <button id="advaiconv-new-person-btn" class="action-btn secondary xs-btn"
                                title="Create New Persona"><i class="fas fa-user-plus"></i></button>
                        </div>
                        <div class="advaiconv-section-body">
                            <select id="advaiconv-person-add" class="control-select"
                                style="width:100%; margin-bottom: 0.8rem;">
                                <option value="">+ Add Person to Thread...</option>
                            </select>

                            <div class="advaiconv-active-people" id="advaiconv-person-chips">
                                <!-- person chips inserted by JS -->
                                <div class="placeholder-text"
                                    style="font-size: 0.8rem; text-align: center; margin-top: 0.5rem;">No active
                                    subjects in thread.</div>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- RIGHT MAIN: Advanced AI Conv Chat -->
                <div class="advaiconv-chat-area">
                    <div class="advaiconv-chat-header">
                        <h3
                            style="margin: 0; font-size: 0.95rem; color: var(--primary); display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-vial"></i> <span id="advaiconv-active-thread-title">New Simulation</span>
                        </h3>
                        <div id="advaiconv-status-indicator" class="advaiconv-status-badge">IDLE</div>
                    </div>

                    <div class="chat-messages advaiconv-messages-container" id="advaiconv-messages">
                        <div class="arena-placeholder" id="advaiconv-placeholder">
                            <span class="tab-icon" style="font-size:3rem;">üß™</span>
                            <p>Select subjects, configure the environment, and start the simulation!</p>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Files Tab -->
        <div class="main-tab-panel" id="files-panel">
            <div class="panel-header">
                <h2>Workspace Files</h2>
                <div class="file-filters">
                    <select id="domain-filter" class="filter-select">
                        <option value="">All Domains</option>
                        <option value="Finance">Finance</option>
                        <option value="System">System</option>
                        <option value="Data">Data</option>
                        <option value="Code">Code</option>
                        <option value="Audio">Audio</option>
                        <option value="General">General</option>
                    </select>
                    <select id="type-filter" class="filter-select">
                        <option value="">All Types</option>
                        <option value="pdf">PDF</option>
                        <option value="txt">Text</option>
                        <option value="csv">CSV</option>
                        <option value="json">JSON</option>
                        <option value="html">HTML</option>
                    </select>
                    <button id="refresh-files" class="refresh-button">üîÑ Refresh</button>
                </div>
            </div>
            <div class="files-grid" id="files-grid">
                <p class="placeholder-text">No files yet. Ask Misaka to create reports, analysis, or other outputs!</p>
            </div>
        </div>

        <!-- Tools Tab -->
        <div class="main-tab-panel" id="tools-panel">
            <div class="panel-header">
                <h2>Tool Registry</h2>
                <div class="panel-controls">
                    <input type="text" id="tool-search" placeholder="Search tools..." class="search-input">
                    <select id="tool-domain-filter" class="filter-select">
                        <option value="">All Domains</option>
                        <!-- Domains will be populated by JS -->
                    </select>
                    <div class="toggle-control" style="display: flex; align-items: center; margin-right: 1rem;">
                        <input type="checkbox" id="hide-system-tools" style="margin-right: 0.5rem;">
                        <label for="hide-system-tools" style="font-size: 0.9rem; cursor: pointer;">Hide System
                            Tools</label>
                    </div>
                    <button id="refresh-tools-btn" class="action-btn secondary" title="Refresh list">
                        <i class="fas fa-redo"></i> Refresh
                    </button>
                    <button id="forge-tool-button" class="forge-button">+ Forge New Tool</button>
                </div>
            </div>

            <div class="tools-table-container" style="overflow-x: auto;">
                <table class="data-table" id="tools-table" style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="text-align: left; border-bottom: 2px solid var(--border);">
                            <th class="sortable" data-sort="name" style="padding: 10px; cursor: pointer;">Tool Name ‚Üï
                            </th>
                            <th class="sortable" data-sort="domain" style="padding: 10px; cursor: pointer;">Domain ‚Üï
                            </th>
                            <th class="sortable" data-sort="usage" style="padding: 10px; cursor: pointer;">Usage ‚Üï</th>
                            <th style="padding: 10px;">Description</th>
                            <th class="sortable" data-sort="created" style="padding: 10px; cursor: pointer;">Created ‚Üï
                            </th>
                            <th style="padding: 10px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tools-table-body">
                        <!-- Rows injected by JS -->
                        <tr>
                            <td colspan="5" class="placeholder-text" style="text-align: center; padding: 20px;">Loading
                                tools...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Packages Tab -->
        <div class="main-tab-panel" id="packages-panel">
            <div class="panel-header">
                <h2>Package Management</h2>
                <div class="panel-controls">
                    <input type="text" id="package-search" placeholder="Search packages..." class="search-input">
                    <select id="package-status-filter" class="filter-select">
                        <option value="all">All Status</option>
                        <option value="pending">Pending</option>
                        <option value="installed">Installed</option>
                        <option value="approved">Approved</option>
                        <option value="denied">Denied</option>
                        <option value="failed">Failed</option>
                    </select>
                    <div class="toggle-control"
                        style="display: flex; align-items: center; gap: 0.5rem; color: var(--text-secondary); font-size: 0.9rem;">
                        <input type="checkbox" id="hide-system-packages">
                        <label for="hide-system-packages">Hide System Pkgs</label>
                    </div>
                    <button id="sync-packages-btn" class="action-btn secondary" title="Sync with installed packages">
                        <i class="fas fa-sync"></i> Sync
                    </button>
                    <button id="refresh-packages-btn" class="action-btn secondary" title="Refresh list">
                        <i class="fas fa-redo"></i>
                    </button>
                </div>
            </div>

            <div class="packages-table-container" style="overflow-x: auto;">
                <table class="data-table" id="packages-table" style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="text-align: left; border-bottom: 2px solid var(--border);">
                            <th class="sortable" data-sort="name" style="padding: 10px; cursor: pointer;">Package ‚Üï</th>
                            <th class="sortable" data-sort="status" style="padding: 10px; cursor: pointer;">Status ‚Üï
                            </th>
                            <th class="sortable" data-sort="usage" style="padding: 10px; cursor: pointer;">Usage ‚Üï</th>
                            <th class="sortable" data-sort="safety" style="padding: 10px; cursor: pointer;">Safety ‚Üï
                            </th>
                            <th class="sortable" data-sort="updated" style="padding: 10px; cursor: pointer;">Updated ‚Üï
                            </th>
                            <th style="padding: 10px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="packages-table-body">
                        <!-- Rows injected by JS -->
                        <tr>
                            <td colspan="6" class="placeholder-text" style="text-align: center; padding: 20px;">Loading
                                packages...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Memory Tab -->
        <div class="main-tab-panel" id="memory-panel">
            <div class="panel-header">
                <h2>System Memory</h2>
                <div class="panel-controls">
                    <button id="refresh-memory-btn" class="action-btn secondary" title="Refresh memory">
                        <i class="fas fa-redo"></i> Refresh
                    </button>
                </div>
            </div>

            <!-- Permanent Memory Section -->
            <div class="memory-section" style="margin-bottom: 2rem;">
                <h3 style="margin-left: 1rem; color: var(--accent);">Permanent Memory (Core Insights)</h3>
                <div class="tools-table-container" style="overflow-x: auto;">
                    <table class="data-table" id="permanent-memory-table"
                        style="width: 100%; border-collapse: collapse; margin-top: 0.5rem;">
                        <thead>
                            <tr style="text-align: left; border-bottom: 2px solid var(--border);">
                                <th style="padding: 10px;">Insight ID</th>
                                <th style="padding: 10px;">Summary</th>
                                <th style="padding: 10px;">Created</th>
                            </tr>
                        </thead>
                        <tbody id="permanent-memory-body">
                            <!-- Rows injected by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Thread Memory Section -->
            <div class="memory-section">
                <h3 style="margin-left: 1rem; color: var(--accent);">Thread Memory</h3>
                <div id="thread-memory-container">
                    <!-- Dynamic thread tables injected here -->
                    <p class="placeholder-text">Loading thread memories...</p>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <!-- Image Studio Tab -->
        <div class="main-tab-panel" id="image-panel">
            <div class="image-studio-container">
                <!-- Main Viewer Area -->
                <div class="image-studio-viewer" id="image-viewer-container">
                    <div class="empty-state-viewer">
                        <i class="fas fa-image" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <h3>Image Studio</h3>
                        <p>Generate, Edit, or View Images</p>
                    </div>
                    <!-- Loading Overlay -->
                    <div class="image-loading-overlay" id="image-loading-overlay" style="display: none;">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">GENERATING...</div>
                    </div>
                </div>

                <!-- Sidebar Controls -->
                <div class="image-studio-sidebar">
                    <div class="sidebar-header">
                        <h3>CONTROLS</h3>
                    </div>
                    <div class="sidebar-content">
                        <!-- Controls -->
                        <div class="control-group">
                            <label>Mode</label>
                            <select class="term-select" style="width: 100%;">
                                <option value="generate">Generate</option>
                                <option value="edit">Edit</option>
                                <option value="upscale">Upscale</option>
                            </select>
                        </div>

                        <div class="control-group" style="margin-top: 1rem;">
                            <label>Model</label>
                            <select class="term-select" id="image-model-selector" style="width: 100%;">
                                <option value="flux-schnell">Flux Schnell</option>
                                <option value="sd-xl">Stable Diffusion XL</option>
                                <option value="dall-e-3">DALL-E 3</option>
                            </select>
                        </div>

                        <div class="control-group" style="margin-top: 1rem;">
                            <label>Prompt</label>
                            <textarea class="term-input" id="image-prompt-input" rows="4"
                                placeholder="Describe your image..."></textarea>
                        </div>
                        <button class="term-btn primary" id="generate-image-btn"
                            style="width: 100%; margin-top: 1rem;">GENERATE</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Usage Tab -->
        <div class="main-tab-panel" id="usage-panel">
            <div class="panel-header">
                <h2>Usage Dashboard</h2>
            </div>
            <div class="usage-dashboard">
                <!-- Stat Cards Row -->
                <div class="usage-stat-row">
                    <div class="usage-stat-card">
                        <div class="stat-value" id="usage-total-calls">0</div>
                        <div class="stat-label">Total API Calls</div>
                    </div>
                    <div class="usage-stat-card">
                        <div class="stat-value" id="usage-total-tokens">0</div>
                        <div class="stat-label">Total Tokens</div>
                    </div>
                    <div class="usage-stat-card">
                        <div class="stat-value" id="usage-input-cost">$0.00</div>
                        <div class="stat-label">Input Cost</div>
                    </div>
                    <div class="usage-stat-card">
                        <div class="stat-value" id="usage-output-cost">$0.00</div>
                        <div class="stat-label">Output Cost</div>
                    </div>
                    <div class="usage-stat-card">
                        <div class="stat-value" id="usage-success-rate">0%</div>
                        <div class="stat-label">Success Rate</div>
                    </div>
                </div>

                <!-- Charts Row 1 -->
                <div class="usage-charts-row">
                    <div class="usage-chart-container">
                        <h3>API Calls by Provider</h3>
                        <canvas id="chart-provider-calls"></canvas>
                    </div>
                    <div class="usage-chart-container">
                        <div class="chart-header-row">
                            <h3>Token Usage Over Time</h3>
                            <div class="chart-controls">
                                <button class="chart-time-btn active" data-range="1w">1w</button>
                                <button class="chart-time-btn" data-range="1d">1d</button>
                            </div>
                        </div>
                        <canvas id="chart-tokens-timeline"></canvas>
                    </div>
                </div>

                <!-- Charts Row 2 -->
                <div class="usage-charts-row">
                    <div class="usage-chart-container">
                        <h3>Estimated Cost by Model</h3>
                        <canvas id="chart-cost-by-model"></canvas>
                    </div>
                    <div class="usage-chart-container">
                        <h3>Tokens by Model</h3>
                        <canvas id="chart-tokens-by-model"></canvas>
                    </div>
                </div>

                <!-- Model Usage Table (full width, above recent calls) -->
                <div class="usage-table-full">
                    <h3>Model Usage</h3>
                    <table class="usage-table">
                        <thead>
                            <tr>
                                <th>Model</th>
                                <th>Calls</th>
                                <th>Tokens Input</th>
                                <th>Tokens Output</th>
                                <th>Total Tokens</th>
                                <th>Est. Cost</th>
                            </tr>
                        </thead>
                        <tbody id="usage-model-tbody">
                            <tr>
                                <td colspan="6" class="placeholder-text">No data yet</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Recent API Calls Table (full width) -->
                <div class="usage-table-full">
                    <h3>Recent API Calls</h3>
                    <table class="usage-table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Source</th>
                                <th>Provider</th>
                                <th>Model</th>
                                <th>In Tokens</th>
                                <th>Out Tokens</th>
                                <th>Input Cost</th>
                                <th>Output Cost</th>
                            </tr>
                        </thead>
                        <tbody id="usage-recent-tbody">
                            <tr>
                                <td colspan="8" class="placeholder-text">No data yet</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div class="main-tab-panel" id="settings-panel">
            <div class="panel-header">
                <h2>System Settings</h2>
            </div>
            <div class="settings-container">
                <div class="setting-group">
                    <h3>Validation & Context</h3>

                    <div class="setting-item">
                        <label class="switch">
                            <input type="checkbox" id="setting-strict-mode">
                            <span class="slider round"></span>
                        </label>
                        <div class="setting-label">
                            <strong>Strict Domain Validation</strong>
                            <span>
                                Enforce Aethvion naming conventions (Domain_Action_Object) and restrict usage to
                                approved
                                domains only.
                                Disable this to allow creating agents with custom domains (e.g. Story_Write_Plot).
                            </span>
                        </div>
                    </div>

                </div>

                <div class="setting-group">
                    <h3>Package Management</h3>
                    <div class="setting-item">
                        <label class="switch">
                            <input type="checkbox" id="setting-hide-system-pkgs">
                            <span class="slider round"></span>
                        </label>
                        <div class="setting-label">
                            <strong>Hide System Packages</strong>
                            <span>Filter out internal system packages from the packages list view.</span>
                        </div>
                    </div>
                </div>


                <!-- Developer Mode -->
                <div class="setting-group dev-mode-group">
                    <div class="setting-item" style="border-bottom: none;">
                        <div class="setting-label" style="flex:1;">
                            <strong>üîß Developer Mode</strong>
                            <span>Reveal sensitive configuration options. Resets on page refresh.</span>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="setting-dev-mode">
                            <span class="slider round"></span>
                        </label>
                    </div>
                </div>

                <!-- .env Management (hidden by default, shown by dev mode) -->
                <div class="setting-group env-section" id="env-section" style="display:none;">
                    <h3>üîë Environment Variables (.env)</h3>
                    <p style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 1rem;">
                        API keys are stored in your local <code>.env</code> file and never committed to version control.
                    </p>
                    <div id="env-status-container">
                        <div class="loading-placeholder">Checking .env status...</div>
                    </div>
                </div>

                <div class="setting-group">
                    <h3>Provider Settings</h3>
                    <p style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 1rem;">
                        Configure AI providers, priorities, and retry budgets per step. Saved to
                        <code>model_registry.json</code>.
                    </p>

                    <!-- Unsaved indicator -->
                    <div id="provider-unsaved-banner" class="unsaved-banner" style="display:none;">
                        ‚ö† Unsaved changes ‚Äî click Save to apply
                    </div>

                    <div id="provider-cards-container" class="provider-cards-grid">
                        <div class="loading-placeholder">Loading providers...</div>
                    </div>
                    <div style="margin-top: 1rem; display: flex; align-items: center; gap: 1rem;">
                        <button id="save-provider-settings" class="btn-primary">Save Provider Settings</button>
                        <span id="provider-save-status" style="color: var(--accent); font-size: 0.85rem;"></span>
                    </div>
                </div>
            </div>
        </div>
        </div>
        </div>

        <!-- System Status Panel -->
        <div class="main-tab-panel" id="status-panel">
            <div class="panel-header borderless">
                <h2 class="status-header-title">Status</h2>

                <div class="status-meta">
                    <span id="system-name-display" class="meta-primary">Misaka Cipher</span>
                    <span class="status-divider">::</span>
                    <span id="system-company-display" class="meta-primary">Aethvion</span>
                    <span class="status-divider">::</span>
                    <span id="system-version-display" class="meta-primary">v1.2.0</span>
                </div>
                <div class="status-meta" style="margin-top: 0.5rem;">
                    <a href="#" id="system-contact-display" class="meta-primary"
                        style="text-decoration: none; font-size: 0.8rem;"></a>
                </div>
            </div>

            <div class="status-container">
                <!-- Realtime Vitals Section -->
                <div class="section-label">REALTIME VITALS <span class="live-indicator">‚óè LIVE</span></div>
                <div id="realtime-info-grid" class="status-telemetry-grid">
                    <!-- Populated by JS (CPU, RAM, Agents, Nexus) -->
                </div>

                <!-- Local System Info Section -->
                <div class="section-header-row">
                    <div class="section-label">LOCAL SYSTEM INFO</div>
                    <div class="local-meta-right">
                        <span class="last-update" style="margin-right: 1rem;">LAST SYNC: <span
                                id="telemetry-last-sync">--</span></span>
                        <button id="sync-telemetry-btn" class="icon-btn xs-btn" title="Sync Local Info"
                            onclick="syncSystemTelemetry()">
                            <i class="fas fa-sync"></i> Sync
                        </button>
                    </div>
                </div>
                <div id="local-info-grid" class="status-telemetry-grid">
                    <!-- Populated by JS (Project Size, DB Size, Tools) -->
                </div>

                <!-- Features Checklist -->
                <div class="section-header-row">
                    <div class="section-label" style="margin-bottom: 0;">ROADMAP & FEATURES</div>
                    <div class="local-meta-right" style="display: flex; align-items: center; gap: 1rem;">
                        <span class="last-update" style="margin-right: 0;">UPDATED: <span
                                id="status-last-update">--</span></span>
                        <button id="roadmap-view-toggle" class="action-btn secondary xs-btn"
                            onclick="toggleRoadmapView()" style="display: flex; gap: 0.4rem; align-items: center;">
                            <i class="fas fa-list"></i> Detailed View
                        </button>
                    </div>
                </div>
                <div class="roadmap-tree">
                    <!-- Roadmap items injected via JS -->
                    <div class="loading-placeholder">Loading system status...</div>
                </div>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <script src="/static/lib/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="/static/js/threads.js?v=4"></script>
    <!-- Core & State Management -->
    <script src="/static/js/core.js?v=1"></script>

    <!-- Views (Passive Data Renderers) -->
    <script src="/static/js/view-files.js?v=1"></script>
    <script src="/static/js/view-memory.js?v=1"></script>
    <script src="/static/js/view-tools.js?v=1"></script>
    <script src="/static/js/view-packages.js?v=1"></script>
    <script src="/static/js/view-usage.js?v=1"></script>
    <script src="/static/js/view-status.js?v=1"></script>
    <script src="/static/js/view-settings.js?v=1"></script>

    <!-- Modes (Active Interactive Panels) -->
    <script src="/static/js/mode-image.js?v=1"></script>
    <script src="/static/js/mode-arena.js?v=1"></script>
    <script src="/static/js/mode-aiconv.js?v=1"></script>
    <script src="/static/js/mode-adv-aiconv.js?v=2"></script>
    <script src="/static/js/mode-chat.js?v=1"></script>
</body>

</html>