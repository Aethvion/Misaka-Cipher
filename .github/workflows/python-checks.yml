name: Python Checks

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read

jobs:
  lint:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v6

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install lint tools
      run: |
        python -m pip install --upgrade pip
        pip install flake8

    - name: Lint — syntax errors and undefined names
      run: |
        flake8 core tests tools \
          --count --select=E9,F63,F7,F82 \
          --show-source --statistics \
          --exclude=__pycache__,.venv,venv,env

    - name: Lint — style warnings (non-blocking)
      run: |
        flake8 core tests tools \
          --count --exit-zero \
          --max-complexity=10 --max-line-length=127 --statistics \
          --exclude=__pycache__,.venv,venv,env

    - name: Check for leaked secrets
      run: |
        ! grep -r "sk-[a-zA-Z0-9]" --include="*.py" --include="*.yaml" --exclude-dir=".git" . \
          || (echo "Potential OpenAI API key found" && exit 1)
        ! grep -r "AIza[a-zA-Z0-9]" --include="*.py" --include="*.yaml" --exclude-dir=".git" . \
          || (echo "Potential Google API key found" && exit 1)

  test:
    name: Import & Structure Checks
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v6

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install core dependencies
      run: |
        python -m pip install --upgrade pip
        # Install without memory extras (chromadb/sentence-transformers are heavy)
        pip install fastapi uvicorn pydantic pyyaml python-dotenv psutil rich requests

    - name: Verify package structure
      run: |
        python -c "import yaml; print('pyyaml OK')"
        python -c "import fastapi; print('fastapi OK')"
        python -c "import rich; print('rich OK')"

    - name: Verify core module imports resolve
      run: |
        python -c "from core.utils import get_logger; print('core.utils OK')"
        python -c "from core.memory.memory_spec import EpisodicEntry; print('core.memory OK')"
        python -c "from core.workspace.preferences_manager import get_preferences_manager; print('core.workspace OK')"

    - name: Verify entry point exists
      run: |
        python -c "import importlib.util; spec = importlib.util.find_spec('core.main'); assert spec, 'core.main not found'; print('core.main OK')"
