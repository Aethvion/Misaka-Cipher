# SYSTEM_SPEC.md - Machine-Readable System Specification

**Note: This documentation was generated by GitHub Copilot on 2026-02-18. It represents a point-in-time snapshot. While core architecture is consistent, specific tool implementations evolve during agentic sprints.**

---

## SYSTEM IDENTITY

```
Name: Misaka Cipher
Acronym: M.I.S.A.K.A.
Full Name: Multitask Intelligence & Strategic Analysis Kernel Architecture
Framework: A.E.G.I.S. (Aethvion-Empowered Generative Intelligence System)
Version: Sprint 3+
Language: Python 3.10+
Primary Purpose: Self-evolving agentic system for autonomous tool generation and task execution
```

---

## DIRECTORY STRUCTURE

```
MisakaCipher/
├── main.py                      # Entry point (CLI/Web/Test modes)
├── cli.py                       # Interactive CLI interface
├── nexus_core.py                # Central orchestration hub [SINGLE POINT OF ENTRY]
│
├── cli_modules/                 # CLI module implementations
│   ├── nexus_module.py          # Nexus Core CLI interactions
│   ├── factory_module.py        # Factory CLI interactions
│   ├── forge_module.py          # Forge CLI interactions
│   ├── memory_module.py         # Memory CLI interactions
│   └── system_module.py         # System status display
│
├── config/                      # Configuration files
│   ├── aethvion.yaml            # Aethvion framework standards
│   ├── providers.yaml           # Provider configuration & failover
│   ├── model_registry.json      # Model definitions & routing strategy [KEY FILE]
│   ├── security.yaml            # Intelligence Firewall rules
│   ├── memory.yaml              # Memory tier configuration
│   └── logging.yaml             # Logging configuration
│
├── orchestrator/                # Master Orchestrator (Autonomous coordination)
│   ├── master_orchestrator.py   # Main orchestration logic
│   ├── intent_analyzer.py       # User intent detection
│   ├── task_queue.py            # Task queueing system
│   ├── task_models.py           # Task data models
│   └── output_validator.py      # Output validation
│
├── factory/                     # The Factory (Agent spawning)
│   ├── agent_factory.py         # Main spawning engine [ENTRY]
│   ├── base_agent.py            # Agent base class
│   ├── generic_agent.py         # Generic agent implementation
│   ├── agent_spec.py            # Agent specification models
│   ├── agent_registry.py        # Active agent tracking
│   ├── agent_result.py          # Agent result models
│   └── agent_templates.py       # Pre-defined agent templates
│
├── forge/                       # The Forge (Tool generation)
│   ├── tool_forge.py            # Main forging engine [ENTRY]
│   ├── code_generator.py        # Python code generation
│   ├── tool_validator.py        # Validation & security checking
│   ├── tool_registry.py         # Tool registration system
│   ├── tool_spec.py             # Tool specification models
│   └── validators/              # Validation modules
│       └── tool_validator.py    # Tool validation logic
│
├── memory/                      # The Memory Tier (Knowledge persistence)
│   ├── episodic_memory.py       # Vector-based interaction storage [ChromaDB]
│   ├── knowledge_graph.py       # Relationship mapping [NetworkX]
│   ├── summarization.py         # Memory summarization
│   ├── memory_spec.py           # Memory data models
│   └── storage/                 # Persistent storage
│       ├── chroma_db/           # ChromaDB vector database
│       └── knowledge_graph.json # Graph persistence
│
├── providers/                   # Provider abstraction layer
│   ├── provider_manager.py      # Provider coordination & failover
│   ├── base_provider.py         # Provider interface
│   ├── google_provider.py       # Google AI (Gemini)
│   ├── openai_provider.py       # OpenAI (GPT)
│   └── grok_provider.py         # xAI (Grok)
│
├── security/                    # Intelligence Firewall
│   ├── firewall.py              # Main firewall coordination
│   ├── scanner.py               # Content scanning (PII/credentials)
│   └── router.py                # Routing decision logic
│
├── tools/                       # Tool registry
│   ├── standard/                # Core system tools
│   ├── generated/               # AI-generated tools [DYNAMIC]
│   └── register_standard_tools.py
│
├── web/                         # Web dashboard
│   ├── server.py                # Flask + SocketIO server
│   ├── static/                  # Frontend assets
│   └── templates/               # HTML templates
│
├── utils/                       # Utility modules
│   ├── logger.py                # Logging utilities
│   ├── trace_manager.py         # Trace ID management
│   └── validators.py            # Input validation
│
├── workspace/                   # Workspace management
│   └── workspace_manager.py     # File system operations
│
├── WorkFolder/                  # AI output directory
│
└── tests/                       # Test suite
    ├── test_factory.py
    ├── test_forge.py
    ├── test_memory.py
    └── test_integration.py
```

---

## DATA FLOW ARCHITECTURE

### Entry Point → Execution Flow

```
[main.py]
    ↓
[Mode Selection]
    ├─→ --cli → [cli.py] → [MisakaCLI]
    ├─→ --test → [run_verification_tests()]
    └─→ default → [web/server.py] → [Flask App]
         ↓
[User Input/Request]
         ↓
[nexus_core.NexusCore.route_request()] ← SINGLE POINT OF ENTRY
         ↓
    ┌────┴────┐
    │ FIREWALL│ [security/firewall.py]
    │ SCAN    │ - PII Detection
    └────┬────┘ - Credential Scanning
         ↓      - Routing Decision
    ┌────┴────────────────┐
    │ ROUTING DECISION    │
    └─┬───────────┬───────┘
      │           │
      ↓           ↓
   [LOCAL]    [EXTERNAL]
  (Roadmap)   (Current)
      │           │
      │           ↓
      │      [providers/provider_manager.py]
      │           │
      │           ↓
      │      [Provider Selection + Failover]
      │           ↓
      │      ┌────┴────┬─────────┬─────────┐
      │      │         │         │         │
      │      ↓         ↓         ↓         ↓
      │   [Google] [OpenAI] [Grok]  [Future]
      │      │         │         │
      │      └─────────┴─────────┘
      │               ↓
      └──────────→ [Response]
                      ↓
                 [Trace Logging]
                      ↓
                 [Memory Storage] (Optional)
                      ↓
                 [Return to User]
```

### Orchestrator Flow (Web Interface)

```
[Web Chat Input]
         ↓
[orchestrator/master_orchestrator.py]
         ↓
    ┌────┴────┐
    │ INTENT  │ [intent_analyzer.py]
    │ ANALYSIS│ → Detect: Chat/Tool/Agent/Memory request
    └────┬────┘
         ↓
    ┌────┴─────────────────┐
    │ ACTION PLAN          │
    └─┬──────┬──────┬──────┘
      │      │      │
      ↓      ↓      ↓
   [Chat] [Tool] [Agent]
      │      │      │
      ↓      ↓      ↓
   [Nexus] [Forge] [Factory]
      │      │      │
      └──────┴──────┘
             ↓
        [Execution]
             ↓
        [Validation]
             ↓
    [Memory Recording]
             ↓
        [Response]
```

### Factory (Agent Spawning) Flow

```
[factory/agent_factory.py::spawn(spec)]
         ↓
[Validate Aethvion Naming]
    [Domain]_[Action]_[Object]
         ↓
[Check Resource Limits]
    max_concurrent_agents: 10
         ↓
[Create Agent Instance]
    [base_agent.py + generic_agent.py]
         ↓
[Register in agent_registry]
         ↓
[Agent Executes via Nexus Core]
         ↓
[Agent Returns Result]
         ↓
[Agent Self-Terminates]
         ↓
[Unregister from registry]
```

### Forge (Tool Generation) Flow

```
[forge/tool_forge.py::forge_tool(description)]
         ↓
[Load Model Registry]
    config/model_registry.json
         ↓
[Build Provider Context]
    Available APIs: GOOGLE_AI_API_KEY, OPENAI_API_KEY, etc.
         ↓
[Analyze Description via Nexus]
    Extract: domain, action, object, parameters
         ↓
[Generate Code]
    [code_generator.py]
    Template: Aethvion-compliant structure
         ↓
[Validate Tool]
    [tool_validator.py]
    - Security scan
    - Syntax check
    - Aethvion compliance
         ↓
[Save to tools/generated/]
    Filename: [domain]_[action]_[object].py
         ↓
[Register in tool_registry]
         ↓
[Tool Available System-Wide]
```

### Memory Tier Flow

```
[Interaction Occurs]
         ↓
[memory/episodic_memory.py]
         ↓
[Generate Embedding]
    sentence-transformers/all-MiniLM-L6-v2
         ↓
[Store in ChromaDB]
    Collection: episodic_memories
         ↓
[Update Knowledge Graph]
    [memory/knowledge_graph.py]
    NetworkX graph
         ↓
[Periodic Summarization]
    [memory/summarization.py]
    Distill into Core Insights
         ↓
[Persist to Disk]
    storage/knowledge_graph.json
```

---

## EXTERNAL API TOUCHPOINTS

### Cloud Provider APIs

```
Google AI:
- Endpoint: https://generativelanguage.googleapis.com/v1beta
- API Key: GOOGLE_AI_API_KEY (env var)
- Models: gemini-2.0-flash, gemini-1.5-pro-latest, imagen-3.0-generate-002
- Priority: 1 (Primary)

OpenAI:
- Endpoint: https://api.openai.com/v1
- API Key: OPENAI_API_KEY (env var)
- Models: gpt-4o, gpt-4o-mini, dall-e-3
- Priority: 2 (Fallback)

xAI Grok:
- Endpoint: https://api.x.ai/v1
- API Key: GROK_API_KEY (env var)
- Models: grok-3-mini-fast
- Priority: 3 (Tertiary)

Local (Roadmap):
- Endpoint: http://localhost:11434 (Ollama) or custom vLLM
- API Key: None
- Models: llama3, mistral, custom
- Priority: 2 (High for data processing)
- Status: NOT IMPLEMENTED (Intelligence Firewall prepared)
```

### Local File System Touchpoints

```
Configuration:
- config/*.yaml
- config/*.json
- .env

Memory Persistence:
- memory/storage/chroma_db/ (ChromaDB)
- memory/storage/knowledge_graph.json (NetworkX)

Tool Storage:
- tools/generated/*.py (AI-created tools)
- tools/registry.json (Tool metadata)

Workspace:
- WorkFolder/ (AI output directory)
- workspace/ (temporary files)

Logs:
- logs/misaka_cipher.log (main log)
- logs/trace_*.log (per-trace logs)
```

---

## MODEL REGISTRY SPECIFICATION

**File:** `config/model_registry.json`

**Structure:**
```json
{
  "providers": {
    "[provider_name]": {
      "active": boolean,
      "priority": integer,
      "api_key_env": "ENV_VAR_NAME",
      "retries_per_step": integer,
      "models": {
        "[model_key]": {
          "id": "model-identifier",
          "capabilities": ["chat", "analysis", "code_generation", ...],
          "tier": "fast|premium|specialized|local",
          "input_cost_per_1m_tokens": float,
          "output_cost_per_1m_tokens": float,
          "notes": "Usage guidelines",
          "description": "Human-readable description"
        }
      }
    }
  },
  "routing_strategy": {
    "verification": "model_key",
    "generation": "model_key",
    "complex_architecture": "model_key",
    "image_generation": "model_key",
    "simple_chat": "model_key"
  }
}
```

**Current Routing Strategy:**
- `verification`: "flash" (Gemini 2.0 Flash)
- `generation`: "flash" (Gemini 2.0 Flash)
- `complex_architecture`: "pro" (Gemini 1.5 Pro)
- `image_generation`: "imagen" (Imagen 3)
- `simple_chat`: "flash" (Gemini 2.0 Flash)

---

## TOOL DEFINITIONS

### Standard Tools (Preloaded)

```
tools/standard/
├── file_ops.py         # File system operations
├── data_ops.py         # Data processing utilities
└── system_ops.py       # System information retrieval
```

### Tool Registration Format

**File:** `tools/registry.json`

```json
{
  "tools": [
    {
      "name": "[Domain]_[Action]_[Object]",
      "path": "tools/generated/[domain]_[action]_[object].py",
      "description": "Natural language description",
      "parameters": [
        {
          "name": "param_name",
          "type": "str|int|float|bool|list|dict",
          "required": true|false,
          "description": "Parameter description"
        }
      ],
      "created_at": "ISO-8601 timestamp",
      "trace_id": "MCTR-...",
      "status": "active|deprecated|testing"
    }
  ]
}
```

### Tool Validation Checklist

**Security Checks:**
- ✓ No arbitrary code execution
- ✓ No external network calls without explicit API keys
- ✓ No file system access outside WorkFolder (unless explicitly allowed)
- ✓ No credential leakage in logs

**Aethvion Compliance:**
- ✓ Naming: `[Domain]_[Action]_[Object]`
- ✓ Docstring: Function signature + description
- ✓ Error handling: Try-except blocks
- ✓ Type hints: Input/output types specified

**Functional Validation:**
- ✓ Syntax valid (ast.parse succeeds)
- ✓ Required parameters defined
- ✓ Return value matches specification

---

## AGENT DEFINITIONS

### Agent Lifecycle States

```
CREATED → INITIALIZING → ACTIVE → EXECUTING → COMPLETED → TERMINATED
                                           ↓
                                         FAILED → TERMINATED
```

### Agent Registry Tracking

**File:** `factory/agent_registry.py` (in-memory)

```python
{
  "agent_id": {
    "name": "[Domain]_[Action]_[Object]",
    "spec": AgentSpec,
    "status": "active|completed|failed|terminated",
    "created_at": timestamp,
    "updated_at": timestamp,
    "trace_id": "MCTR-...",
    "result": AgentResult (if completed)
  }
}
```

### Agent Templates

**File:** `factory/agent_templates.py`

```python
AGENT_TEMPLATES = {
  "data_analysis": {
    "domain": "Data",
    "capabilities": ["read_files", "analyze", "visualize"],
    "tools": ["file_ops", "data_ops"]
  },
  "code_generation": {
    "domain": "Code",
    "capabilities": ["generate", "validate", "test"],
    "tools": ["forge"]
  },
  # ... more templates
}
```

---

## MEMORY SYSTEM SPECIFICATION

### Episodic Memory (ChromaDB)

**Collection:** `episodic_memories`

**Document Structure:**
```python
{
  "id": "memory_id_[timestamp]_[uuid]",
  "content": "Full interaction text",
  "embedding": [vector of floats],  # Generated by embedding model
  "metadata": {
    "trace_id": "MCTR-...",
    "timestamp": "ISO-8601",
    "type": "user_input|ai_response|system_event",
    "provider": "google_ai|openai|grok",
    "model": "model-identifier",
    "tags": ["tag1", "tag2"]
  }
}
```

**Retrieval:**
- Query: Natural language string
- Returns: Top-N similar memories (default: 10)
- Method: Cosine similarity on embeddings

### Knowledge Graph (NetworkX)

**Node Types:**
- `Domain`: High-level category (e.g., "Data", "Code", "System")
- `Tool`: Generated or standard tools
- `Agent`: Spawned agents
- `Concept`: Extracted key concepts
- `Insight`: Core summarized insights

**Edge Types:**
- `uses`: Tool → Tool (dependency)
- `spawned_by`: Agent → Tool/User
- `related_to`: Concept ↔ Concept
- `derived_from`: Insight → Memory

**Persistence:**
- Format: JSON (NetworkX serialization)
- File: `memory/storage/knowledge_graph.json`
- Update: On every tool forge, agent spawn, memory summarization

### Core Insights

**Generation:**
- Trigger: Every N episodic memories (configurable, default: 100)
- Method: LLM summarization via Nexus Core
- Storage: ChromaDB metadata + Knowledge Graph

**Format:**
```python
{
  "insight_id": "insight_[timestamp]_[uuid]",
  "content": "High-level summarized fact",
  "source_memories": ["memory_id_1", "memory_id_2"],
  "confidence": 0.0-1.0,
  "created_at": "ISO-8601"
}
```

---

## TRACE MANAGEMENT

**Trace ID Format:** `MCTR-YYYYMMDDHHMMSS-UUID`

**Example:** `MCTR-20260218104223-a3f2c1b9`

**Trace Lifecycle:**
1. `start_trace()` → Generate ID
2. Request processing → Log to trace-specific file
3. `end_trace(status)` → Mark complete/failed
4. Persist metadata to memory

**Trace Log Location:**
- `logs/trace_MCTR-20260218104223-a3f2c1b9.log`

**Trace Metadata:**
```python
{
  "trace_id": "MCTR-...",
  "start_time": "ISO-8601",
  "end_time": "ISO-8601",
  "status": "completed|failed|blocked",
  "request_type": "generation|tool_execution|agent_call",
  "provider": "google_ai|openai|grok",
  "model": "model-identifier",
  "firewall_status": "clean|flagged|blocked",
  "routing_decision": "external|local"
}
```

---

## SECURITY FIREWALL RULES

**File:** `config/security.yaml`

**PII Detection Patterns:**
- Email addresses: `[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}`
- Phone numbers: `(\+\d{1,3}[\s-]?)?\(?\d{3}\)?[\s.-]?\d{3}[\s.-]?\d{4}`
- Credit cards: `\b\d{4}[\s-]?\d{4}[\s-]?\d{4}[\s-]?\d{4}\b`
- SSN: `\b\d{3}-\d{2}-\d{4}\b`

**Credential Detection Patterns:**
- API keys: `[A-Za-z0-9_-]{32,}`
- AWS keys: `AKIA[0-9A-Z]{16}`
- Passwords in plain text: `password\s*[:=]\s*[^\s]+`

**Routing Logic:**
- CLEAN → EXTERNAL (cloud providers)
- FLAGGED → LOCAL (when available) / WARNING (current)
- BLOCKED → Reject request

---

## WORKSPACE MANAGEMENT

**Primary Directory:** `WorkFolder/`

**Purpose:**
- AI-generated files (code, data, reports)
- Temporary processing files
- Agent output files

**Structure:**
```
WorkFolder/
├── agents/           # Agent-specific output
│   └── [agent_name]/
├── tools/            # Tool-generated output
│   └── [tool_name]/
├── reports/          # Analysis reports
└── temp/             # Temporary files (auto-cleanup)
```

**Cleanup Policy:**
- `temp/`: Cleared every 24 hours
- `agents/`: Retained for 30 days (configurable)
- `tools/`: Persistent
- `reports/`: Persistent

---

## CONFIGURATION OVERRIDE PRIORITY

```
1. Runtime parameters (highest)
2. Environment variables (.env)
3. Config files (config/*.yaml, config/*.json)
4. System defaults (lowest)
```

**Example:**
```python
# Runtime override
Request(preferred_provider="openai")  # Ignores config priority

# Environment variable
GOOGLE_AI_API_KEY=xyz  # Overrides config

# Config file
providers.yaml: priority: 1  # Default behavior
```

---

## AETHVION STANDARD COMPLIANCE

**Naming Convention:** `[Domain]_[Action]_[Object]`

**Valid Domains:**
- Data, Code, System, Network, Image, Text, Math, Finance, etc.

**Valid Actions:**
- Create, Read, Update, Delete, Analyze, Generate, Transform, Validate, etc.

**Valid Objects:**
- Singular nouns: File, CSV, JSON, Image, Report, etc.

**Invalid Names:**
- Snake_case without structure: `my_tool_123`
- CamelCase: `MyToolName`
- Lowercase: `mytool`
- Special characters: `My-Tool!`

---

## DEPENDENCIES

**Core:**
```
python>=3.10
google-generativeai  # Google AI
openai              # OpenAI
requests            # HTTP client
```

**Orchestration:**
```
pyyaml              # Config parsing
python-dotenv       # Environment variables
```

**Memory:**
```
chromadb            # Vector database
sentence-transformers  # Embeddings
networkx            # Graph engine
```

**Web:**
```
flask               # Web server
flask-socketio      # WebSocket
uvicorn             # ASGI server
```

**Utilities:**
```
rich                # CLI formatting
click               # CLI framework
```

**Full list:** See `requirements.txt`

---

## TESTING INFRASTRUCTURE

**Test Directories:**
- `tests/` - Unit and integration tests
- `tests/test_factory.py` - Factory tests
- `tests/test_forge.py` - Forge tests
- `tests/test_memory.py` - Memory tests
- `tests/test_integration.py` - End-to-end tests

**Run Tests:**
```bash
# Verification test
python main.py --test

# Full test suite
pytest tests/

# Specific module
pytest tests/test_forge.py -v
```

---

## SYSTEM STATUS MONITORING

**Health Check Endpoints:**
```python
nexus.get_status()
# Returns:
{
  'initialized': True,
  'providers': {
    'google_ai': {'status': 'available', 'model': 'gemini-2.0-flash'},
    'openai': {'status': 'available', 'model': 'gpt-4o'},
    'grok': {'status': 'unavailable', 'error': 'No API key'}
  },
  'firewall': {'active': True, 'rules_loaded': 15},
  'active_traces': 3
}
```

**Factory Status:**
```python
factory.get_status()
# Returns:
{
  'active_agents': 2,
  'max_concurrent': 10,
  'total_spawned': 47,
  'total_completed': 45,
  'total_failed': 0
}
```

**Forge Status:**
```python
forge.get_status()
# Returns:
{
  'total_tools': 23,
  'standard_tools': 3,
  'generated_tools': 20,
  'validation_rate': 0.95,
  'tools_dir': '/path/to/tools/generated'
}
```

---

## LOGGING CONFIGURATION

**File:** `config/logging.yaml`

**Log Levels:**
- DEBUG: Detailed diagnostic information
- INFO: General system events
- WARNING: Warning messages (e.g., flagged requests)
- ERROR: Error messages (e.g., provider failures)
- CRITICAL: Critical system failures

**Log Rotation:**
- Max size: 10MB per file
- Backup count: 5 files
- Format: `%(asctime)s - %(name)s - %(levelname)s - %(message)s`

**Log Files:**
- `logs/misaka_cipher.log` - Main system log
- `logs/trace_*.log` - Per-trace detailed logs
- `logs/security.log` - Firewall and security events

---

## VERSION INFORMATION

**Current Version:** Sprint 3+ (February 2026)

**Version History:**
- Sprint 1: Core Nexus, Provider abstraction, Intelligence Firewall
- Sprint 2: Factory, Agent spawning, Aethvion compliance
- Sprint 3: Forge, Tool generation, Memory tier
- Sprint 4 (Roadmap): Local model integration, Advanced orchestration

**Breaking Changes:**
- Sprint 3: Tool registry format changed (added `status` field)
- Sprint 3: Agent naming now enforces Aethvion standard

---

## PERFORMANCE METRICS

**Target Metrics:**
- Request latency: <2s (Flash), <5s (Pro)
- Tool generation: <30s (simple), <120s (complex)
- Agent spawn: <1s
- Memory retrieval: <500ms (10 results)

**Current Bottlenecks:**
- Provider API latency (external)
- ChromaDB embedding generation (~200ms/query)
- NetworkX graph persistence (~1s for large graphs)

**Optimization Strategies:**
- Cache frequently used embeddings
- Batch memory updates
- Lazy-load knowledge graph

---

## ERROR CODES

```
NEXUS-001: Provider unavailable
NEXUS-002: Request blocked by firewall
NEXUS-003: Routing failed

FACTORY-001: Invalid agent name (Aethvion violation)
FACTORY-002: Resource limit exceeded
FACTORY-003: Agent execution failed

FORGE-001: Tool generation failed
FORGE-002: Tool validation failed
FORGE-003: Tool registration failed

MEMORY-001: ChromaDB connection failed
MEMORY-002: Embedding generation failed
MEMORY-003: Knowledge graph persistence failed

SECURITY-001: PII detected
SECURITY-002: Credential detected
SECURITY-003: Request blocked
```

---

**LAST UPDATED:** 2026-02-18

**MAINTAINED BY:** Agentic Sprint Cycles

**STABILITY:** Core architecture stable, tool implementations evolve rapidly
